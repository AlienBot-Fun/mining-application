const{ipcRenderer:ipcRenderer}=require("electron"),electron=require("electron").remote,Excel=electron.require("exceljs"),Twig=electron.require("twig"),shema=electron.require("./data/shema");$(function(){window.UI=new Object({lang:{},settings:{},access_data:{status:"off"},init:()=>{UI.helpers.lang(),UI.groups.get_list(!1),UI.helpers.settings(),UI.tools.interactive(),UI.tools.access_token(!0),UI.planner.init()},planner:{status:"STOP",accounts:[],init:function(){let e=UI.groups.get_grid();ipcRenderer.invoke("accounts").then(t=>{let n=t.slice(0,10);n.length>0&&UI.helpers.tpl("layouts/home/list_wait.twig",{items:n,groups:e,lang:UI.lang}).then(e=>{$(".javascript-list-wait").html(e)})}),ipcRenderer.on("planner_data",(e,t)=>{UI.planner.building_wait_listing(t),UI.planner.building_work_listing(t)}),ipcRenderer.on("planner_meta",(e,t)=>{$(".javascript-controlInterval").text(t.interval_starting>60?">60":t.interval_starting)}),UI.planner.tools.init()},tools:{init:()=>{setTimeout(()=>{$(`select[name="window_interval"] option[value="${UI.settings.count_opened_window}"]`).prop("selected",!0).removeAttr("disabled"),$(`select[name="account_interval"] option[value="${UI.settings.account_interval}"]`).prop("selected",!0).removeAttr("disabled"),$('select[name="window_interval"]').removeAttr("disabled"),$('select[name="account_interval"]').removeAttr("disabled")},2e3)},runAll:async()=>{await UI.accounts.get_list(),await UI.groups.get_list(),ipcRenderer.invoke("accounts").then(e=>{let t=e;t=t.filter(e=>"active"==e.status),"on"===UI.access_data.status&&t.length>0?(ipcRenderer.send("planner_command","START"),$("a.javascript-playment-run").removeAttr("disabled"),$("a.javascript-playment-stop").removeAttr("disabled"),$("a.javascript-playment-run").attr("disabled","disabled"),UI.planner.status="START"):UI.helpers.alert("error",UI.lang.registry.no_mining)})},stopedAll:()=>{UI.planner.status="STOP",ipcRenderer.send("planner_command","STOP"),$("a.javascript-playment-run").removeAttr("disabled"),$("a.javascript-playment-stop").removeAttr("disabled"),$("a.javascript-playment-stop").attr("disabled","disabled")},selectWindowInterval:function(e){let t=$(e).val();UI.settings.account_interval=t,ipcRenderer.send("set_meta",{key:"count_opened_window",value:t})},selectAccountInterval:function(e){let t=$(e).val();UI.settings.count_opened_window=t,ipcRenderer.send("set_meta",{key:"account_interval",value:t})}},building_work_listing:e=>{let t=e.filter(e=>1==e.bender.status.mining);(t=t.filter(e=>"active"==e.status)).sort((e,t)=>e.bender.timeout<t.bender.timeout?1:e.bender.timeout>t.bender.timeout?-1:0);let n=UI.groups.get_grid();UI.helpers.tpl("layouts/home/list_work.twig",{items:t,groups:n,lang:UI.lang}).then(e=>{$(".javascript-list-work").html(e)})},building_wait_listing:e=>{let t=e.filter(e=>0==e.bender.status.mining);(t=t.filter(e=>"active"==e.status)).sort((e,t)=>e.climetime>t.climetime?1:e.climetime<t.climetime?-1:0);let n=UI.groups.get_grid();UI.helpers.tpl("layouts/home/list_wait.twig",{items:t,groups:n,lang:UI.lang}).then(e=>{$(".javascript-list-wait").html(e)})},show_account_modal:e=>{},show_account_modal_worked:e=>{}},tools:{check_cpu:e=>{let t=$(e).prop("checked");ipcRenderer.send("check_cpu",t)},hidden_btn:e=>{$(e).hasClass("checked")?($(e).removeClass("checked"),$(e).find("i").removeClass("fa-eye"),$(e).find("i").addClass("fa-eye-slash"),$("body").addClass("text-blur")):($(e).addClass("checked"),$(e).find("i").removeClass("fa-eye-slash"),$("body").removeClass("text-blur"),$(e).find("i").addClass("fa-eye"))},alcor:e=>{ipcRenderer.send("alcor_auth",e)},wallet:e=>{ipcRenderer.send("wallet_auth",e)},session_token:e=>{ipcRenderer.send("session_token",e)},interactive:()=>{$("[data-toggle=tooltip]").tooltip(),$("body").on("click","button[external], a[external]",function(e){return e.preventDefault(),ipcRenderer.send("link",$(this).attr("external")),!1}),$("form#form-settings").on("submit",function(e){e.preventDefault();let t=$(this).serializeArray();return"STOP"===UI.planner.status?ipcRenderer.invoke("save_settings",t).then(e=>{"success"===e.status&&($(".javascript-status-settings").text(e.message),UI.tools.access_token(!0))}):UI.helpers.alert("error",UI.lang.registry.no_saved),!1}),$("#import-groups").on("change",function(e){var t=e.target.files,n=t.length>0&&t[0];if(!1!==n){var a=new FileReader;a.readAsArrayBuffer(n),a.onload=async function(e){let t=new Excel.Workbook;var n=a.result;t.xlsx.load(n).then(async e=>{let t=e.getWorksheet("groups"),n=t.actualRowCount,a=t.getRow(1).values,s=t.getRows(2,n);Promise.all(s.map(e=>{var t={};if(e.values.map((e,n)=>{var s=e;s="[object Number]"==={}.toString.call(e)?Number(e):s,s="[object Object]"==={}.toString.call(e)?"":s,s="[object Array]"==={}.toString.call(e)?"":s,s="[object String]"==={}.toString.call(e)?s.toString():s,t[a[n]]=s}),void 0!==t.id)return t})).then(async e=>{e=e.filter(e=>null!==e&&void 0!==e);ipcRenderer.invoke("groups_import",e).then(e=>{"success"===e.status&&UI.groups.get_list(!0)})})})}}}),$("#import-accounts").on("change",function(e){var t=e.target.files,n=t.length>0&&t[0];if(!1!==n){var a=new FileReader;a.readAsArrayBuffer(n),a.onload=async function(e){let t=new Excel.Workbook;var n=a.result;t.xlsx.load(n).then(async e=>{let t=e.getWorksheet("accounts"),n=t.actualRowCount,a=t.getRow(1).values,s=t.getRows(2,n);Promise.all(s.map(e=>{var t={};if(e.values.map((e,n)=>{var s=e;s="[object Number]"==={}.toString.call(e)?Number(e):s,s="[object Object]"==={}.toString.call(e)?"":s,s="[object Array]"==={}.toString.call(e)?"":s,s="[object String]"==={}.toString.call(e)?s.toString():s,t[a[n]]=s}),t.wax_login)return t})).then(async e=>{e=e.filter(e=>null!==e&&void 0!==e);UI.helpers.is_account_insert(e.length).then(t=>{t?ipcRenderer.invoke("accounts_import",e).then(t=>{if(UI.accounts.get_list(!0),UI.accounts.sync_accountList(),e.length>0){let t=e.map(e=>e.wax_login);UI.accounts.planned_addAccounts(t)}}).catch(()=>{UI.accounts.get_list(!0),UI.accounts.sync_accountList()}):UI.helpers.alert("error",UI.lang.registry.limited)})})})}}}),$("input#account-search").on("keyup",function(){var e=$(this).val(),t=UI.accounts.list.slice(0).map(e=>e.wax_login);e.length>1?($(".javascript-listingContent-accounts tr[data-waxlogin]").addClass("d-none"),t=t.filter(t=>{t.indexOf(e)>-1&&$(`.javascript-listingContent-accounts tr[data-waxlogin="${t}"]`).removeClass("d-none")})):$(".javascript-listingContent-accounts tr[data-waxlogin]").removeClass("d-none")})},access_token:(e=!0)=>{ipcRenderer.invoke("access_token").then(t=>{void 0!==t.status&&"success"===t.status?(UI.access_data=t.result,UI.access_data.status="on"):UI.access_data={status:"off"},e&&UI.tools.access_token_rebuild()})},access_token_rebuild:()=>{let e=`AlienBot PRO ★ ${UI.lang.pages.home.title}`,t=`\n                    <p class="mb-0 w-100">${UI.lang.registry.no}</p>\n                    <button external="https://alienbot.fun/account/nodes/form" class="btn btn-sm btn-success">${UI.lang.registry.no_btn}</button>\n                `;"on"===UI.access_data.status&&(e="AlienBot PRO ★ "+UI.access_data.header,t=`\n                        <p class="mb-0 w-100">${UI.lang.registry.ok} ${UI.access_data.count} <span class="ml-2 mr-2">  ★  </span> ${UI.lang.registry.ok2} ${UI.access_data.balance} WAX</p>\n                        <button external="https://alienbot.fun/account/nodes/form/${UI.access_data.hash}" class="btn btn-sm btn-success" >${UI.lang.registry.ok_btn}</button>\n                    `),$("title").text(e),$(".javascript-status_bar").html(t)}},helpers:{tpl_list:[],tpl:async(e,t)=>{let n=UI.helpers;const a=await new Promise((t,a)=>{let s=n.tpl_list.filter(t=>t.name===e);0==s.length?ipcRenderer.invoke("tpl",{tplname:e}).then(a=>{n.tpl_list.push({name:e,string:a}),t(a)}):t(s[0].string)});return await new Promise((e,n)=>{e(Twig.twig({data:a}).render(t))})},ajax:(e,t={},n=!1)=>{ipcRenderer.invoke("tpl",{tplname:e}).then(e=>{let a=Twig.twig({data:e}).render(t);$("#pageModal .modal-content").html(a),$("#pageModal").modal("show"),n&&n()})},lang:async()=>{ipcRenderer.invoke("lang").then(e=>{UI.lang=e})},settings:async()=>{ipcRenderer.invoke("settings").then(e=>{UI.settings=e})},alert:(e,t,n)=>{var a=UI.lang,n=n||!1,e=e||"error",s=t||a.bell.alert.default;"success"===e&&iziToast.success({title:a.bell.alert.success,message:s,position:"bottomCenter"}),"error"===e&&iziToast.error({title:a.bell.alert.error,message:s,position:"bottomCenter"}),n&&n()},confirm:(e,t,n)=>{var a=UI.lang,e=e||"Вопрос?",s=n||a.bell.confirm.buttons,t=t||function(e){};return iziToast.show({theme:"dark",icon:"icon-person",title:a.bell.confirm.header,message:e,position:"center",progressBarColor:"rgb(0, 255, 184)",buttons:[["<button>"+s[0]+"</button>",function(e,n){e.hide({transitionOut:"fadeOutUp",onClosing:function(e,n,a){t(!0)}},n,"buttonName")},!0],["<button>"+s[1]+"</button>",function(e,n){e.hide({transitionOut:"fadeOutUp",onClosing:function(e,n,a){t(!1)}},n,"buttonName")}]]}),!0},time:()=>Math.round((new Date).getTime()/1e3),timetoFormat:e=>{var t=new Date(1e3*e),n={d:t.getDate()<10?"0"+t.getDate():t.getDate(),m:t.getMonth()<10?"0"+t.getMonth():t.getMonth(),y:t.getFullYear(),h:t.getHours()<10?"0"+t.getHours():t.getHours(),i:t.getMinutes()<10?"0"+t.getMinutes():t.getMinutes()};return`${n.d}.${n.m}.${n.y} ${n.h}:${n.i}`},is_account_insert:async function(e=!1){return void 0!==UI.access_data.status&&"on"===UI.access_data.status&&(!1!==e?Number(e)<=Number(UI.access_data.count):Number(UI.accounts.list.length)<Number(UI.access_data.count))}},groups:{list:[],get_list:(e=!1)=>{ipcRenderer.invoke("groups").then(t=>{UI.groups.list=t,e&&UI.groups.rendered()})},delete:(e,t=!0)=>{UI.helpers.confirm(UI.lang.pages.group.listing_js_removed,function(n){n&&ipcRenderer.invoke("groups_remove",e).then(e=>{UI.groups.list=e,t&&UI.groups.rendered()})})},get_grid:()=>{let e={};return UI.groups.list.map(t=>{e[t.id]=t.header}),e},rendered:()=>{UI.helpers.tpl("layouts/groups/listing.twig",{groups:UI.groups.list,lang:UI.lang}).then(e=>{$(".javascript-listingContent-groups").html(e),$("[data-toggle=tooltip]").tooltip()})},import:()=>{UI.helpers.confirm(UI.lang.pages.group.js_isImportant,function(e){e&&$("#import-groups").trigger("click")})},export:async()=>{ipcRenderer.invoke("groups").then(e=>{if(e.length>0){var t=new Excel.Workbook,n=t.addWorksheet("groups");let a=[];Object.keys(shema.groups).forEach(e=>{a.push({header:e,key:e,width:10})}),n.columns=a,Promise.all(e.map(e=>{n.addRow(e)})).then(async()=>{let e=await t.xlsx.writeBuffer();ipcRenderer.send("download",{fileName:"alienbot-groups-export.xlsx",fileData:e})})}})},edit:(e=0)=>{let t=UI.groups.list.find(t=>+t.id==e)||{},n=void 0!==t.id?UI.lang.pages.group.header_edit:UI.lang.pages.group.header_create;UI.helpers.ajax("layouts/groups/forma.twig",{header:n,item:t,lang:UI.lang},()=>{$("input[name=worktime]").inputmask("99:99-99:99"),$("form#form-group").on("submit",function(e){e.preventDefault();let t=!(+$("input[name=id]").val()>0),n=$(this).serializeArray();return ipcRenderer.invoke("group_edit",{is_created:t,data:n}).then(e=>{$("form#form-group .javascript-status").text(e.mess),UI.groups.get_list(!0),$("#pageModal").modal("hide")}),!1})})},export_pattern:()=>{ipcRenderer.send("download_file",{fileName:"alienbot-groups-pattern.xlsx",filePath:"data/alienbot-groups-pattern.xlsx",fileExt:".xlsx"})}},accounts:{list:[],get_list:(e=!1)=>{ipcRenderer.invoke("accounts").then(t=>{UI.accounts.list=t,e&&UI.accounts.rendered()})},delete:(e,t=!0)=>{UI.helpers.confirm(UI.lang.pages.accounts.js_isRemoved,function(n){n&&ipcRenderer.invoke("account_remove",e).then(e=>{UI.accounts.list=e,t&&UI.accounts.rendered(),UI.accounts.sync_accountList()})})},rendered:()=>{UI.helpers.tpl("layouts/accounts/listing.twig",{accounts:UI.accounts.list,groups:UI.groups.list,groups_grid:UI.groups.get_grid(),lang:UI.lang}).then(e=>{$(".javascript-listingContent-accounts").html(e),$("[data-toggle=tooltip]").tooltip()})},export:async()=>{ipcRenderer.invoke("accounts").then(e=>{if(e.length>0){var t=new Excel.Workbook,n=t.addWorksheet("accounts");let a=[];Object.keys(shema.accounts).forEach(e=>{a.push({header:e,key:e,width:10})}),n.columns=a,Promise.all(e.map(e=>{n.addRow(e)})).then(async()=>{let e=await t.xlsx.writeBuffer();ipcRenderer.send("download",{fileName:"alienbot-accounts-export.xlsx",fileData:e})})}})},import:()=>{UI.helpers.confirm(UI.lang.pages.accounts.js_isImportant,function(e){e&&$("#import-accounts").trigger("click")})},export_pattern:()=>{ipcRenderer.send("download_file",{fileName:"alienbot-accounts-pattern.xlsx",filePath:"data/alienbot-accounts-pattern.xlsx",fileExt:".xlsx"})},edit:async(e=!1)=>{let t=UI.groups.list,n=UI.accounts.list.find(t=>t.wax_login==e)||{},a=UI.accounts.list.map(e=>e.wax_login)||[],s=void 0!==n.wax_login?UI.lang.pages.accounts.edited:UI.lang.pages.accounts.created;UI.helpers.ajax("layouts/accounts/forma.twig",{header:s,item:n,groups:t,settings:UI.settings,lang:UI.lang},()=>{$("form#form-account").on("submit",function(e){e.preventDefault();let t=$(this).attr("data-iscreted"),n=$(this).serializeArray(),s=n.find(e=>"wax_login"==e.name),r=a.indexOf(s.value)>-1,o=()=>{$("body .modal-content").animate({scrollTop:$('input[name="wax_login"]').offset().top},{duration:370,easing:"linear"}),$('input[name="wax_login"]').css("outline","1px solid red"),setTimeout(()=>{$('input[name="wax_login"]').css("outline","none")},3e3)},i=()=>{ipcRenderer.invoke("account_edit",{is_created:t,data:n}).then(e=>{$("form#form-account .javascript-status").text(e.mess),UI.accounts.get_list(!0),$("#pageModal").modal("hide"),UI.accounts.sync_accountList(),UI.accounts.planned_addAccount(s.value)})},l="EDIT";return"created"===t&&(l="CREATE"),"EDIT"===l&&(""===s.value&&!1===r?o():s.value!==t&&!0===r?o():i()),"CREATE"===l&&(""===s.value|!0===r?o():UI.helpers.is_account_insert().then(e=>{e&&i()})),!1})})},check_tokenMode:e=>{let t=$(e).attr("data-title");return $(".javascript-block-title").text(t),!0},sync_accountList:async()=>{$("#server-preload").removeClass("d-none");try{ipcRenderer.invoke("accounts").then(e=>{let t=[];e.length>0&&(t=e.map(e=>e.wax_login)),fetch("https://api.alienbot.fun/accounts",{method:"post",headers:{"Content-Type":"application/json"},body:JSON.stringify({token:UI.settings.token,accounts:t})}).then(e=>e.json()).then(e=>($("#server-preload").addClass("d-none"),e)).catch(e=>($("#server-preload").addClass("d-none"),{status:"error",message:"Server not fount"}))}).catch(e=>($("#server-preload").addClass("d-none"),{status:"error",message:"Server not fount"}))}catch(e){return $("#server-preload").addClass("d-none"),{status:"error",message:"Undefined error"}}},planned_addAccount:e=>{ipcRenderer.send("add_account",e)},planned_addAccounts:e=>{let t=(e,t)=>{setTimeout(()=>{ipcRenderer.send("add_account",e)},t)},n=0;do{t(e[n],1e3*n),n++}while(n<e.length)},mathed:e=>{if(void 0===$(e).attr("disabled")){$(e).attr("disabled",!0);let t=$("form#form-account").serializeArray(),n=t.find(e=>"email"===e.name),a=t.find(e=>"email_password"===e.name),s=t.find(e=>"imap_server"===e.name),r=t.find(e=>"imap_port"===e.name),o=t.find(e=>"tls"===e.name);""!==n.value&&""!==a.value&&""!==s.value&&""!==r.value&&""!==o.value?ipcRenderer.invoke("account_email_mathed",{email:n.value,password:a.value,server:s.value,port:r.value,tls:o.value}).then(t=>{$(e).removeAttr("disabled"),UI.helpers.alert(t.status,t.message)}):($(e).removeAttr("disabled"),UI.helpers.alert("error",UI.lang.pages.accounts.js_test_mail_error_input))}}}}),UI.init()});